{
  "version": 3,
  "sources": ["../../src/services/user-service.ts"],
  "sourcesContent": ["import { Document } from \"mongoose\";\r\nimport { User } from \"./../models/user\";\r\nimport UserSchemaModel from \"./../models/mongo/user-schema-model\";\r\nimport jwt, { Secret, JwtPayload } from 'jsonwebtoken';\r\nimport bcrypt from \"bcryptjs\";\r\nimport { Request, Response, NextFunction } from 'express';\r\n\r\nexport function index(): Promise<User[]> {\r\n    return UserSchemaModel.find();\r\n}\r\n\r\nexport function get(username: String): Promise<User> {\r\n    return UserSchemaModel.find({ username })\r\n    .then((list) => list[0])\r\n    .catch((err) => {\r\n        throw `${username} Not Found`;\r\n    });\r\n}\r\n\r\nexport function getAllUsers(): Promise<User[]> {\r\n  return UserSchemaModel.find({})\r\n  .then((list) => list)\r\n  .catch((err) => {\r\n      throw `error get all users - ${err} `;\r\n  });\r\n}\r\n\r\nexport function create(user: User): Promise<User> {\r\n    const p = new UserSchemaModel(user);\r\n    return p.save();\r\n}\r\n\r\n\r\nexport function createUser(newUser: User) {\r\n  return new Promise<User>((resolve, reject) => {\r\n    if (!newUser.username || !newUser.password) {\r\n      reject(\"must provide username and password\");\r\n    }\r\n    UserSchemaModel\r\n      .find({ username: newUser.username })\r\n      .then((found: User[]) => {\r\n        if (found && found.length >= 1)\r\n            reject(\"username exists\");\r\n          else return true;\r\n      })\r\n      .then((usernameUnique) =>{\r\n        if (usernameUnique){ \r\n          bcrypt\r\n            .genSalt(10)\r\n            .then((salt: string) => bcrypt.hash(newUser.password, salt))\r\n            .then((hashedPassword: string) => {\r\n              const user = new UserSchemaModel({\r\n                username:newUser.username,\r\n                password: hashedPassword,\r\n                firstName:newUser.firstName,\r\n                lastName: newUser.lastName,\r\n                role: newUser.role ?? \"member\"\r\n              });\r\n              user.save().then((createdNewUser: User) => {\r\n                if (createdNewUser) resolve(createdNewUser);\r\n              });\r\n            })\r\n        }\r\n        }\r\n      );\r\n  });\r\n}\r\n\r\nexport function update(username: String, user: User): Promise<User> {\r\n    return new Promise((resolve, reject) => {\r\n        UserSchemaModel.findOneAndUpdate({ username }, user, {\r\n            new: true,\r\n    }).then((user) => {\r\n        if (user) resolve(user);\r\n        else reject(\"Failed to update user profile\");\r\n    });\r\n    });\r\n}\r\n\r\nexport function loginUser(username: string, password: string) {\r\n  return new Promise((resolve, reject) => {\r\n    if (!username || !password) {\r\n      reject(\"must provide username and password\");\r\n    } else {\r\n      verify(username, password)\r\n        .then((goodUser: String) => generateAccessToken(goodUser))\r\n        .then((token) =>{\r\n          if(token) resolve(token)\r\n        })\r\n        .catch((error) => reject(\"Unauthorized\"));\r\n    }\r\n  })\r\n}\r\n\r\nexport function verify(\r\n  username: string,\r\n  password: string\r\n): Promise<String> {\r\n  return new Promise<String>((resolve, reject) => {\r\n    UserSchemaModel\r\n      .find({ username })\r\n      .then((found) => {\r\n        console.log(found)\r\n        if (found && found.length >= 1) return found[0];\r\n        else reject(\"Invalid username or password\");\r\n      })\r\n      .then((userOnFile) => {\r\n\r\n        if(userOnFile){\r\n          bcrypt.compare(password, userOnFile.password, (err, data) => {\r\n            //if error than throw error\r\n            if (err) throw err\r\n            console.log(data);\r\n            //if both match than you can do anything\r\n            if (data) {\r\n              resolve(userOnFile.username);\r\n                //return res.status(200).json({ msg: \"Login success\" })\r\n            } else {\r\n                reject(\"Invalid username or password\");\r\n                //return res.status(401).json({ msg: \"Invalid credencial\" })\r\n            }\r\n          })\r\n        }\r\n        else reject(\"Invalid username or password\");\r\n        \r\n      });\r\n  });\r\n}\r\n\r\nexport function checkExists(username: string) {\r\n  return new Promise<boolean>((resolve, reject) => {\r\n    UserSchemaModel\r\n      .find({ username })\r\n      .then((found) => resolve(found && found.length > 0));\r\n  });\r\n}\r\n\r\nexport function generateAccessToken(username: String) {\r\n    console.log(\"Generating token for\", username);\r\n    \r\n    return new Promise((resolve, reject) => {\r\n    jwt.sign({ username: username }, process.env.JWT_SECRET as string, \r\n      { expiresIn: '1h'}, \r\n      (err, encodedToken)=>{\r\n          err ? reject(err) : resolve(encodedToken)\r\n      })\r\n    })\r\n  };\r\n\r\n//const getUsernameFromToken = (token) => jwt.decode(token)[\"username\"];\r\n\r\n//exports.getAudienceFromToken = (token) => jwt.decode(token)[\"aud\"];\r\n  \r\nexport default { index, get, getAllUsers, create, update, generateAccessToken, createUser, loginUser, verify }"],
  "mappings": "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",
  "names": ["UserSchemaModel", "bcrypt", "user", "jwt"]
}
